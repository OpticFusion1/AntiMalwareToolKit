package optic_fusion1.antimalwaretoolkit.tool.impl;

import com.gargoylesoftware.htmlunit.BrowserVersion;
import com.gargoylesoftware.htmlunit.WebClient;
import com.gargoylesoftware.htmlunit.html.HtmlPage;
import java.io.IOException;
import java.util.List;
import java.util.logging.Level;
import optic_fusion1.antimalwaretoolkit.tool.Tool;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

public class BukkitPluginDownloader extends Tool {

    private final String cookieStr = "[{\"name\":\"__utmb\",\"value\":\"211817857.1.10.1622545551\",\"domain\":\".dev.bukkit.org\",\"path\":\"/\",\"expires\":1622547350,\"size\":31,\"httpOnly\":false,\"secure\":false,\"session\":false,\"sameParty\":false,\"sourceScheme\":\"Secure\",\"sourcePort\":443},{\"name\":\"__utmt_c\",\"value\":\"1\",\"domain\":\".dev.bukkit.org\",\"path\":\"/\",\"expires\":1622546150,\"size\":9,\"httpOnly\":false,\"secure\":false,\"session\":false,\"sameParty\":false,\"sourceScheme\":\"Secure\",\"sourcePort\":443},{\"name\":\"__utmz\",\"value\":\"211817857.1622545551.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none)\",\"domain\":\".dev.bukkit.org\",\"path\":\"/\",\"expires\":1638313550,\"size\":76,\"httpOnly\":false,\"secure\":false,\"session\":false,\"sameParty\":false,\"sourceScheme\":\"Secure\",\"sourcePort\":443},{\"name\":\"__utmc\",\"value\":\"211817857\",\"domain\":\".dev.bukkit.org\",\"path\":\"/\",\"expires\":-1,\"size\":15,\"httpOnly\":false,\"secure\":false,\"session\":true,\"sameParty\":false,\"sourceScheme\":\"Secure\",\"sourcePort\":443},{\"name\":\"__utma\",\"value\":\"211817857.2125186667.1622545551.1622545551.1622545551.1\",\"domain\":\".dev.bukkit.org\",\"path\":\"/\",\"expires\":1685617550,\"size\":61,\"httpOnly\":false,\"secure\":false,\"session\":false,\"sameParty\":false,\"sourceScheme\":\"Secure\",\"sourcePort\":443},{\"name\":\"__utmb\",\"value\":\"59825598.2.10.1622545551\",\"domain\":\".bukkit.org\",\"path\":\"/\",\"expires\":1622547350,\"size\":30,\"httpOnly\":false,\"secure\":false,\"session\":false,\"sameParty\":false,\"sourceScheme\":\"Secure\",\"sourcePort\":443},{\"name\":\"__utmt_b\",\"value\":\"1\",\"domain\":\".bukkit.org\",\"path\":\"/\",\"expires\":1622546150,\"size\":9,\"httpOnly\":false,\"secure\":false,\"session\":false,\"sameParty\":false,\"sourceScheme\":\"Secure\",\"sourcePort\":443},{\"name\":\"__utmt\",\"value\":\"1\",\"domain\":\".bukkit.org\",\"path\":\"/\",\"expires\":1622546150,\"size\":7,\"httpOnly\":false,\"secure\":false,\"session\":false,\"sameParty\":false,\"sourceScheme\":\"Secure\",\"sourcePort\":443},{\"name\":\"__utmz\",\"value\":\"59825598.1622545551.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none)\",\"domain\":\".bukkit.org\",\"path\":\"/\",\"expires\":1638313550,\"size\":75,\"httpOnly\":false,\"secure\":false,\"session\":false,\"sameParty\":false,\"sourceScheme\":\"Secure\",\"sourcePort\":443},{\"name\":\"__utmc\",\"value\":\"59825598\",\"domain\":\".bukkit.org\",\"path\":\"/\",\"expires\":-1,\"size\":14,\"httpOnly\":false,\"secure\":false,\"session\":true,\"sameParty\":false,\"sourceScheme\":\"Secure\",\"sourcePort\":443},{\"name\":\"Unique_ID_v2\",\"value\":\"7738994b5a7045c09e2fb5c2202fcdaf\",\"domain\":\".bukkit.org\",\"path\":\"/\",\"expires\":1938078349.713861,\"size\":44,\"httpOnly\":false,\"secure\":false,\"session\":false,\"sameParty\":false,\"sourceScheme\":\"Secure\",\"sourcePort\":443},{\"name\":\"__utma\",\"value\":\"59825598.2125186667.1622545551.1622545551.1622545551.1\",\"domain\":\".bukkit.org\",\"path\":\"/\",\"expires\":1685617550,\"size\":60,\"httpOnly\":false,\"secure\":false,\"session\":false,\"sameParty\":false,\"sourceScheme\":\"Secure\",\"sourcePort\":443},{\"name\":\"_ga\",\"value\":\"GA1.2.2125186667.1622545551\",\"domain\":\".bukkit.org\",\"path\":\"/\",\"expires\":1685617550,\"size\":30,\"httpOnly\":false,\"secure\":false,\"session\":false,\"sameParty\":false,\"sourceScheme\":\"Secure\",\"sourcePort\":443},{\"name\":\"_gid\",\"value\":\"GA1.2.865222550.1622545551\",\"domain\":\".bukkit.org\",\"path\":\"/\",\"expires\":1622631950,\"size\":30,\"httpOnly\":false,\"secure\":false,\"session\":false,\"sameParty\":false,\"sourceScheme\":\"Secure\",\"sourcePort\":443},{\"name\":\"__cf_bm\",\"value\":\"00f14afa700ca91febe343fbfe6b4647c5719fa6-1622545549-1800-AYRaL1qwCGmqbON1C9MGxMnY2bsXVS5cVcJWMXdE6e4AIM62Ph3ktPJg8wazQkl/eL36Ik88mOnL56vQkEAplZjmLjy2pOSGWO7TdFM4wg5R\",\"domain\":\".dev.bukkit.org\",\"path\":\"/\",\"expires\":1622547349.713889,\"size\":172,\"httpOnly\":true,\"secure\":true,\"session\":false,\"sameSite\":\"None\",\"sameParty\":false,\"sourceScheme\":\"Secure\",\"sourcePort\":443},{\"name\":\"_ga_N8BTN266HQ\",\"value\":\"GS1.1.1622545550.1.0.1622545550.0\",\"domain\":\".bukkit.org\",\"path\":\"/\",\"expires\":1685617550,\"size\":47,\"httpOnly\":false,\"secure\":false,\"session\":false,\"sameParty\":false,\"sourceScheme\":\"Secure\",\"sourcePort\":443},{\"name\":\"ResponsiveSwitch.DesktopMode\",\"value\":\"1\",\"domain\":\"dev.bukkit.org\",\"path\":\"/\",\"expires\":1653649550,\"size\":29,\"httpOnly\":false,\"secure\":false,\"session\":false,\"sameParty\":false,\"sourceScheme\":\"Secure\",\"sourcePort\":443},{\"name\":\"AWSALBCORS\",\"value\":\"3CqBlRyZwsfVKB/ZXnfngt5y/Ea2iEtMj50UJ4aHYyza73Dw4/0QMaQ6QpnhP8XzuKqmzDbBM5bz/iyYgg1jVTb+qDc2ZxBfCDa7uflibofzlRrlTuwkEj0zyHmD\",\"domain\":\"dev.bukkit.org\",\"path\":\"/\",\"expires\":1623150349.713826,\"size\":134,\"httpOnly\":false,\"secure\":true,\"session\":false,\"sameSite\":\"None\",\"sameParty\":false,\"sourceScheme\":\"Secure\",\"sourcePort\":443},{\"name\":\"AWSALB\",\"value\":\"3CqBlRyZwsfVKB/ZXnfngt5y/Ea2iEtMj50UJ4aHYyza73Dw4/0QMaQ6QpnhP8XzuKqmzDbBM5bz/iyYgg1jVTb+qDc2ZxBfCDa7uflibofzlRrlTuwkEj0zyHmD\",\"domain\":\"dev.bukkit.org\",\"path\":\"/\",\"expires\":1623150349.713709,\"size\":130,\"httpOnly\":false,\"secure\":false,\"session\":false,\"sameParty\":false,\"sourceScheme\":\"Secure\",\"sourcePort\":443}]";

    @Override
    public void run(final List<String> args) {
        final WebClient webClient = new WebClient(BrowserVersion.FIREFOX);
        webClient.getOptions().setJavaScriptEnabled(true);
        webClient.setJavaScriptTimeout(10000);

        webClient.getOptions().setTimeout(15000);
        webClient.getOptions().setCssEnabled(false);
        webClient.getOptions().setRedirectEnabled(true);
        webClient.getOptions().setThrowExceptionOnFailingStatusCode(false);
        webClient.getOptions().setThrowExceptionOnScriptError(false);
        webClient.getOptions().setPrintContentOnFailingStatusCode(false);
        webClient.getOptions().setUseInsecureSSL(true);
        webClient.getOptions().setPopupBlockerEnabled(false);
        java.util.logging.Logger.getLogger("com.gargoylesoftware").setLevel(Level.OFF);

        final Options options = Options.parse(args);
        final int maxPage = options.toPage == -1 ? this.establishPages(webClient) : options.toPage;
        if (maxPage <= 0) {
            System.err.println("Invalid end page");
            return;
        }
    }

    /**
     * Retrieves the amount of pages
     *
     * @param webClient The web client
     *
     * @return The amount of pages
     */
    private int establishPages(final WebClient webClient) {
        try {
            // Fetch page
            final HtmlPage page = webClient.getPage("https://dev.bukkit.org/bukkit-plugins");

            // Parse document and select navigators
            final Elements elements = Jsoup.parse(page.asXml())
                    .body()
                    .select("ul[class=\"b-pagination-list paging-list j-tablesorter-pager j-listing-pagination\"]");

            // Retrieve first navigator
            final Element element = elements.get(0);

            // Retrieve last element of navigator and parse it's link attribute
            final Element child = element.child(element.childrenSize() - 1);
            return Integer.parseInt(child.attr("href").split("=")[1]);
        } catch (final IOException e) {
            e.printStackTrace();
        }
        return 0;
    }

    private void downloadPage(final WebClient webClient, final Options options, final int pageNo) throws IOException {
    }

    private static class Options {

        /**
         * Starting page
         */
        public int fromPage = 1;

        /**
         * End page
         * -1 = Last available page
         */
        public int toPage = -1;

        /**
         * Sorting mode
         * 1 = Date created
         * 2 = Last updated
         * 3 = Name
         * 4 = Popularity
         * 5 = Total downloads
         */
        public int sort = 2;

        public static Options parse(final List<String> args) {
            final Options options = new Options();

            if (!args.isEmpty()) {
                // Parse args
                for (int i = 0; i < args.size() - 1; i++) {
                    final String arg = args.get(i).toLowerCase();

                    switch (arg) {
                        // Starting page
                        case "from" -> options.fromPage = Integer.parseInt(args.get(i + 1));
                        // End page
                        case "to" -> options.toPage = Integer.parseInt(args.get(i + 1));
                        // Sort
                        case "sort" -> options.sort = Integer.parseInt(args.get(i + 1));
                    }
                }
            }

            return options;
        }

    }

}
